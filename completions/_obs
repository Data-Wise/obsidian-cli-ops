#compdef obs

# Zsh completion for obs (Obsidian CLI Ops)
# Install: Copy to a directory in $fpath (e.g., /usr/local/share/zsh/site-functions/)

_obs() {
    local -a commands
    commands=(
        'check:Check dependencies (curl, jq, unzip)'
        'list:Show configured vaults and R project mappings'
        'sync:Sync Core Config from Root to Sub-vaults'
        'install:Install a Community Plugin'
        'search:Search for a plugin ID'
        'audit:Check for misplaced files in Root'
        'r-dev:R development integration commands'
        'tui:Launch interactive TUI'
        'help:Show help message'
        'version:Show version information'
    )

    local -a r_dev_commands
    r_dev_commands=(
        'link:Link current R project to an Obsidian folder'
        'unlink:Remove current R project mapping'
        'status:Show current R project link status'
        'log:Copy artifact to Obsidian 06_Analysis'
        'context:Fetch theory notes from Knowledge_Base'
        'draft:Copy vignette/Rmd to Obsidian 02_Drafts'
    )

    local -a global_flags
    global_flags=(
        '--verbose:Enable verbose debug logging'
        '-v:Enable verbose debug logging (short form)'
    )

    _arguments -C \
        '(- :)'{-h,--help}'[Show help message]' \
        '(- :)'{-V,--version}'[Show version information]' \
        '(-v --verbose)'{-v,--verbose}'[Enable verbose logging]' \
        '1: :->command' \
        '*:: :->args'

    case "$state" in
        command)
            _describe -t commands 'obs commands' commands
            ;;
        args)
            case "${words[1]}" in
                r-dev)
                    _arguments \
                        '1: :->r_dev_command' \
                        '*:: :->r_dev_args'

                    case "$state" in
                        r_dev_command)
                            _describe -t r_dev_commands 'obs r-dev commands' r_dev_commands
                            ;;
                        r_dev_args)
                            case "${words[1]}" in
                                link)
                                    _message 'obsidian_folder path (e.g., Research_Lab/MyProject)'
                                    ;;
                                log)
                                    _arguments \
                                        '1:file:_files' \
                                        '-m[Message]:message:'
                                    ;;
                                context)
                                    _message 'search term'
                                    ;;
                                draft)
                                    _files
                                    ;;
                            esac
                            ;;
                    esac
                    ;;
                install)
                    _arguments \
                        '1:plugin name:' \
                        '2:flag:(--all --vault)' \
                        '3:vault name:'
                    ;;
                search)
                    _message 'plugin search query'
                    ;;
                sync)
                    _arguments \
                        '1:flag:(--force)'
                    ;;
            esac
            ;;
    esac
}

_obs "$@"
